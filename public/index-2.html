<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>robocam</title>
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; padding: 20px; background: linear-gradient(to bottom, #f4f4f4, #e0e0e0); min-height: 100vh; }
  #loginForm, #changeForm { margin-bottom: 20px; }
  #app { display: none; }
  #statusDisplay { margin-top: 10px; font-weight: bold; }
  .top-bar { display: flex; align-items: left; justify-content: left; gap: 10px; flex-wrap: wrap; width: 100%; max-width: 600px; margin-bottom: 10px; }
  .buttons { display: flex; flex-wrap: wrap; gap: 8px; }
  .app-icon { width: 40px; height: 40px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
  button, select { font-size: 1em; padding: 8px 16px; margin: 0; border: none; border-radius: 10px; background-color: #808080; color: white; cursor: pointer; transition: background-color 0.3s, transform 0.1s; }
  button:hover:enabled { background-color: #45a049; }
  button:disabled { cursor: not-allowed; opacity: 0.8; }
  button.active { background-color: #00FF00; transform: scale(1.05); }
  #stopBtn { background-color: #FF0000; }
  #stopBtn:hover:enabled { background-color: #d32f2f; }
  video { margin-top: 1px; border: 2px solid #333; border-radius: 5px; background: #000; object-fit: cover; }
  #remoteVideo, #localVideo { width: 80%; max-width: 100%; }
  #blackoutBtn, #audioBtn { background-color: grey; opacity: 1; z-index: 99999; }
  #blackoutArea { display: none; position: fixed; top:0; left:0; width:100vw; height:100vh; background-color:black; opacity:1; z-index:9999; }
  .inline-container img { vertical-align: middle; height:40px; }
  .inline-container span { vertical-align: middle; margin-left:10px; font-size:40px; }
  .fullscreen-video { position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:10000; background:black; object-fit:cover; object-position:center; }
  .fullscreen-toggle { position:absolute; top:10px; right:10px; z-index:10001; background-color:rgba(0,0,0,0.6); padding:8px 14px; border-radius:6px; font-size:0.9em; color:white; }
</style>
</head>
<body>

<div id="loginForm">
  <h2>Login</h2>
  <input type="password" id="password" placeholder="Enter Password">
  <button onclick="login()">Login</button>
  <p id="loginMsg"></p>
</div>

<div id="changeForm" style="display:none;">
  <h3>Passwort ändern (nur Masterpasswort)</h3>
  <input type="password" id="newPassword" placeholder="New Password">
  <button onclick="changePassword()">Ändern</button>
  <p id="changeMsg"></p>
</div>

<div id="app">
  <div class="top-bar">
    <div class="buttons">
      <button id="senderBtn" onclick="start('sender')">send</button>
      <button id="receiverBtn" onclick="start('receiver')">receive</button>
      <button id="stopBtn" onclick="stopAll()" style="display:none;">Stop</button>
      <button id="audioBtn" onclick="toggleAudio()">Audio Off</button>
      <button id="blackoutBtn" onclick="blackoutScreen()">Off</button>
      <button id="reconnectBtn" onclick="attemptReconnect()" style="display:none;">Reconnect</button>
      <button id="hideLocal" onclick="hideLocal()">Local Off</button>
      <button id="hideRemote" onclick="hideRemote()">Remote Off</button>
      <select id="cameraSelect" style="display:none;"></select>
    </div>
    <div id="blackoutArea"></div>
  </div>
  <div id="statusDisplay">Status: idle</div>
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay playsinline></video>
  <button id="toggleFullscreenBtn" class="fullscreen-toggle" onclick="toggleFullscreen()" style="display:none;">Fullscreen</button>
</div>

<script>
const ConnectionState = { IDLE:'idle', WAITING:'waiting', READY:'ready', CONNECTED:'connected', ERROR:'error' };
let appState = ConnectionState.IDLE;
let pc, localStream, localOfferSent=false, blackOut=false, remoteOut=true, localOut=true, myRole=null, audioSetting=true, ws;
let iceServers = []; // Dynamische ICE Server

// --- Xirsys ICE Server abrufen ---
async function fetchXirsysIceServers(){
  const xhr = new XMLHttpRequest();
  return new Promise((resolve,reject)=>{
    xhr.onreadystatechange = function(){
      if(xhr.readyState===4){
        if(xhr.status===200){
          const res = JSON.parse(xhr.responseText);
          iceServers = res.v.iceServers;
          console.log("[ICE SERVERS]", iceServers);
          resolve();
        } else reject(xhr.responseText);
      }
    };
    xhr.open("PUT","https://global.xirsys.net/_turn/robocam",true);
    xhr.setRequestHeader("Authorization","Basic "+btoa("aborsro:e2d37f0c-800f-11f0-98d4-0242ac150002")); // Dein Xirsys Secret
    xhr.setRequestHeader("Content-Type","application/json");
    xhr.send(JSON.stringify({format:"urls"}));
  });
}

// --- App State ---
function setAppState(state){
  appState=state;
  document.getElementById('statusDisplay').textContent=`Status: ${state}`;
  document.getElementById('reconnectBtn').style.display=state===ConnectionState.ERROR?'block':'none';
  document.getElementById('toggleFullscreenBtn').style.display=state===ConnectionState.CONNECTED?'block':'none';
}

// --- Login ---
async function login(){
  const pw=document.getElementById("password").value;
  const res=await fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:pw})});
  const data=await res.json();
  if(data.success){
    document.getElementById("loginForm").style.display="none";
    if(data.message==="master") document.getElementById("changeForm").style.display="block";
    else document.getElementById("app").style.display="block";
  } else document.getElementById("loginMsg").innerText="Wrong Password!";
}
async function changePassword(){
  const newPw=document.getElementById("newPassword").value;
  const master=document.getElementById("password").value;
  const res=await fetch("/change-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({master,newPassword:newPw})});
  const data=await res.json();
  document.getElementById("changeMsg").innerText=data.message;
  document.getElementById("loginForm").style.display="block";
  document.getElementById("changeForm").style.display="none";
  document.getElementById('password').value="";
}

// --- WebSocket ---
function connectWebSocket(){
  const wsProtocol = location.protocol==='https:'?'wss':'ws';
  ws = new WebSocket(`${wsProtocol}://${location.host}/ws`);
  ws.onopen=()=>{ if(myRole) ws.send(JSON.stringify({type:'register',role:myRole,roomId:'id1'})); setAppState(ConnectionState.WAITING); };
  ws.onmessage=handleMessage;
  ws.onerror=e=>console.error(e);
  ws.onclose=()=>{ setAppState(ConnectionState.ERROR); setTimeout(connectWebSocket,3000); };
}
connectWebSocket();

// --- Camera ---
async function fillCameraSelect(){
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoDevices = devices.filter(d=>d.kind==='videoinput');
  const select = document.getElementById('cameraSelect');
  select.innerHTML='';
  videoDevices.forEach((device,idx)=>{
    const option=document.createElement('option');
    option.value=device.deviceId;
    option.text=device.label||`Kamera ${idx+1}`;
    select.appendChild(option);
  });
  if(videoDevices.length===1){ select.value=videoDevices[0].deviceId; await startLocalStreamAndOffer(); }
  select.onchange=async()=>{ await startLocalStreamAndOffer(); };
}

// --- Handle Messages ---
async function handleMessage(msg){
  const text = msg.data instanceof Blob ? await msg.data.text() : msg.data;
  let data;
  try{ data=JSON.parse(text); }catch{return;}
  if(!pc) return;

  if(data.type==='receiver-ready' && myRole==='sender'){ setAppState(ConnectionState.READY); await startLocalStreamAndOffer(); return; }

  if(data.sdp){
    const remoteDesc = new RTCSessionDescription(data.sdp);
    if((pc.signalingState==='stable' && remoteDesc.type==='offer') || (pc.signalingState==='have-local-offer' && remoteDesc.type==='answer')){
      await pc.setRemoteDescription(remoteDesc);
      if(remoteDesc.type==='offer'){
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({sdp:pc.localDescription}));
      }
    } else console.warn("[DEBUG] setRemoteDescription skipped", pc.signalingState, remoteDesc.type);
  } else if(data.candidate){
    try{ await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); }
    catch(e){ console.warn("addIceCandidate failed:", e); }
  }
}

// --- Start Sender/Receiver ---
async function start(role){
  myRole=role;
  await fetchXirsysIceServers(); // Dynamisch ICE Server holen
  if(ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({type:'register',role:myRole,roomId:'id1'}));
  document.getElementById('senderBtn').disabled=true;
  document.getElementById('receiverBtn').disabled=true;
  document.getElementById('stopBtn').style.display='block';
  setAppState(ConnectionState.WAITING);

  pc = new RTCPeerConnection({ iceServers });

  pc.ontrack=e=>document.getElementById('remoteVideo').srcObject=e.streams[0];
  pc.onicecandidate=e=>{ if(e.candidate) ws.send(JSON.stringify({candidate:e.candidate})); };
  pc.oniceconnectionstatechange=()=>{ 
    console.log("[ICE State]", pc.iceConnectionState);
    if(['disconnected','failed'].includes(pc.iceConnectionState)){ setAppState(ConnectionState.ERROR); attemptReconnectWithDelay(5); }
    if(pc.iceConnectionState==='connected'){ setAppState(ConnectionState.CONNECTED); }
  };

  if(role==='sender'){ document.getElementById('cameraSelect').style.display='block'; await fillCameraSelect(); await startLocalStreamAndOffer(); }
  if(role==='receiver'){ document.getElementById('remoteVideo').style.display='block'; }
}

// --- Local Stream ---
async function startLocalStreamAndOffer(){
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
  const select=document.getElementById('cameraSelect');
  const videoConstraints=select.options.length>0?{ deviceId:{ exact: select.value } } : true;
  localStream = await navigator.mediaDevices.getUserMedia({video:videoConstraints,audio:audioSetting});
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
  document.getElementById('localVideo').srcObject=localStream;
  if(!localOfferSent){ 
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({sdp:pc.localDescription}));
    localOfferSent=true;
  }
}

// --- Buttons ---
function hideRemote(){ remoteOut=!remoteOut; document.getElementById('remoteVideo').style.display=remoteOut?'block':'none'; document.getElementById('hideRemote').textContent=remoteOut?'Remote On':'Remote Off'; }
function hideLocal(){ localOut=!localOut; document.getElementById('localVideo').style.display=localOut?'block':'none'; document.getElementById('hideLocal').textContent=localOut?'Local Off':'Local On'; }
function blackoutScreen(){ blackOut=!blackOut; document.getElementById('blackoutArea').style.display=blackOut?'block':'none'; document.getElementById('blackoutBtn').textContent=blackOut?'Display':'Off'; }
function toggleAudio(){ audioSetting=!audioSetting; if(localStream)localStream.getAudioTracks().forEach(t=>t.enabled=audioSetting); document.getElementById('audioBtn').textContent=audioSetting?'Audio Off':'Audio On'; }
function stopAll(){ setAppState(ConnectionState.IDLE); localOfferSent=false; myRole=null; if(pc){ pc.close(); pc=null; } if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; } document.getElementById('senderBtn').disabled=false; document.getElementById('receiverBtn').disabled=false; document.getElementById('stopBtn').style.display='none'; document.getElementById('cameraSelect').style.display='none'; document.getElementById('localVideo').srcObject=null; document.getElementById('remoteVideo').srcObject=null; document.getElementById('blackoutArea').style.display='none'; }
function attemptReconnectWithDelay(seconds){ setTimeout(()=>{ if(!pc || pc.iceConnectionState==='disconnected'){ stopAll(); if(myRole) start(myRole); } },seconds*1000); }
function attemptReconnect(){ if(appState===ConnectionState.ERROR){ stopAll(); if(myRole) start(myRole); } }

// --- Fullscreen ---
let fullscreenMode=false;
function toggleFullscreen(){
  const localVideo=document.getElementById('localVideo');
  const remoteVideo=document.getElementById('remoteVideo');
  const toggleBtn=document.getElementById('toggleFullscreenBtn');
  const allButtons=document.querySelector('.buttons');
  const statusDisplay=document.getElementById('statusDisplay');

  if(!fullscreenMode){
    if(myRole==='sender'){ localVideo.classList.add('fullscreen-video'); remoteVideo.style.display='none'; }
    if(myRole==='receiver'){ remoteVideo.classList.add('fullscreen-video'); localVideo.style.display='none'; }
    Array.from(allButtons.children).forEach(btn=>{ if(btn.id!=='toggleFullscreenBtn') btn.style.display='none'; });
    statusDisplay.style.display='none';
    toggleBtn.textContent="Zurück";
    fullscreenMode=true;
  } else {
    localVideo.classList.remove('fullscreen-video');
    remoteVideo.classList.remove('fullscreen-video');
    remoteVideo.style.display='block';
    localVideo.style.display='block';
    Array.from(allButtons.children).forEach(btn=>{ btn.style.display=''; });
    statusDisplay.style.display='';
    toggleBtn.textContent="Fullscreen";
    fullscreenMode=false;
  }
}
</script>
</body>
</html>
