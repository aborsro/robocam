<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>robocam</title>
<style>
  body {
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    padding: 20px;
    background: linear-gradient(to bottom, #f4f4f4, #e0e0e0);
    min-height: 100vh;
  }
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px; /* Abstand zwischen Icon und Buttons */
    flex-wrap: wrap; /* umbricht auf kleinen Bildschirmen */
    width: 100%;
    max-width: 600px;
    margin-bottom: 10px;
  }
  .buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .app-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  }
  h1 {
    margin: 10px;
    font-size: 1.8em;
    color: #333;
  }
  button, select {
    font-size: 1.0em;
    padding: 8px 16px;
    margin: 0;
    width: auto;
    max-width: none;
    border: none;
    border-radius: 10px;
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.1s;
  }
  button:hover:enabled {
    background-color: #45a049;
  }
  button:disabled {
    cursor: not-allowed;
    opacity: 0.8;
  }
  button.active {
    background-color: #2196F3;
    transform: scale(1.05);
  }
  #stopBtn {
    background-color: #f44336;
  }
  #stopBtn:hover:enabled {
    background-color: #d32f2f;
  }
  video {
    margin-top: 1px;
    border: 2px solid #333;
    border-radius: 10px;
    background: black;
    object-fit: cover;
  }
  #remoteVideo {
    width: 100%;
    max-width: 100%;
  }
  #localVideo {
    width: 200px;
    position: absolute;
    top: 20px;
    right: 20px;
    border: 2px solid white;
  }
  #blackoutBtn {
    display: block;
    background-color: grey;
    opacity: 1;
    z-index: 99999;
  }
  /* Blackout overlay style */
  #blackoutArea {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: black;
      opacity: 1;
      z-index: 9999;
  }
  .inline-container img {
    vertical-align: middle;
    height: 40px;
  }
  .inline-container span {
    vertical-align: middle;
    margin-left: 10px;
    font-size: 40px;
  }
</style>
</head>
<body>
  <div class="inline-container">
    <img src="favicon.ico" alt="App Icon" class="app-icon">
    <span>robocam</span>
  </div>
  <br>
  <div class="top-bar">
    <div class="buttons">
      <button id="senderBtn" onclick="start('sender')">send</button>
      <button id="receiverBtn" onclick="start('receiver')">receive</button>
      <button id="stopBtn" onclick="stopAll()" style="display:none;">Stop</button>
      <button id="blackoutBtn" onclick="blackoutScreen()" style="background-color:grey;">Off</button>
      <select id="cameraSelect" style="display:none;"></select>
    </div>
    <div id="blackoutArea"></div>
  </div>
  <video id="remoteVideo" autoplay playsinline></video>
  <script>
    console.log("[DEBUG] Initialisiere Babyphone WebRTC App");

    const ws = new WebSocket(location.origin.replace(/^http/, 'ws'));
    let pc;
    let localOfferSent = false;
    let localStream;
    let messageBuffer = [];
    let blackOut = false;

ws.onopen = () => console.log("[DEBUG] WebSocket verbunden");
ws.onerror = e => console.error("[DEBUG] WebSocket Fehler:", e);
ws.onclose = () => console.log("[DEBUG] WebSocket Verbindung geschlossen");

ws.onmessage = handleMessage;

    function blackoutScreen() {
      blackOut = !blackOut;
      document.getElementById('blackoutArea').style.display = blackOut ? 'block' : 'none';
      document.getElementById('blackoutBtn').textContent = blackOut ? 'Display' : 'Off';
    }

    async function handleMessage(msg) {
      let text = msg.data instanceof Blob ? await msg.data.text() : msg.data;
      let data;
      try { data = JSON.parse(text); } catch { return; }

  if (data.sdp) {
    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
    if (data.sdp.type === 'offer') {
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({ sdp: pc.localDescription }));
    }
  } else if (data.candidate) {
    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
  }
}

async function start(role) {
  console.log(`[DEBUG] Starte als ${role}`);

  const senderBtn = document.getElementById('senderBtn');
  const receiverBtn = document.getElementById('receiverBtn');
  const stopBtn = document.getElementById('stopBtn');

      senderBtn.disabled = true;
      receiverBtn.disabled = true;
      senderBtn.textContent = "send";
      receiverBtn.textContent = "receive";

  if (role === 'sender') senderBtn.classList.add('active');
  if (role === 'receiver') receiverBtn.classList.add('active');

  stopBtn.style.display = 'block';

  pc = new RTCPeerConnection();

  pc.ontrack = e => {
    console.log("[DEBUG] ontrack ausgelöst, Stream erhalten:", e.streams[0]);
    document.getElementById('remoteVideo').srcObject = e.streams[0];
  };
  pc.onicecandidate = e => {
    if (e.candidate) ws.send(JSON.stringify({ candidate: e.candidate }));
  };

  if (role === 'sender') {
    const select = document.getElementById('cameraSelect');
    select.style.display = 'block';
    await fillCameraSelect();

    if (select.options.length === 1) {
      console.log("[DEBUG] Nur eine Kamera gefunden – starte direkt");
      await startLocalStreamAndOffer();
    } else {
      select.onchange = async () => {
        console.log("[DEBUG] Kamera gewählt:", select.value);
        await startLocalStreamAndOffer();
      };
    }
  }

  if (role === 'receiver' && !localOfferSent) {
    console.log("[DEBUG] Bereit Offers vom anderen zu empfangen...");
  }
}

async function fillCameraSelect() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoDevices = devices.filter(d => d.kind === 'videoinput');
  console.log("[DEBUG] Gefundene Kameras:", videoDevices);

  const select = document.getElementById('cameraSelect');
  select.innerHTML = '';
  videoDevices.forEach(device => {
    const option = document.createElement('option');
    option.value = device.deviceId;
    option.text = device.label || `Kamera ${select.length + 1}`;
    select.appendChild(option);
  });
}

async function startLocalStreamAndOffer() {
  if (localOfferSent) return;
  localOfferSent = true;

      const select = document.getElementById('cameraSelect');
      const cameraId = select.value;
      let constraints;

      try {
        constraints = (select.options.length === 1)
          ? { video: { width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: true }
          : { video: { deviceId: { exact: cameraId }, width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: true };

    localStream = await navigator.mediaDevices.getUserMedia(constraints);
    document.getElementById('localVideo').srcObject = localStream;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ sdp: pc.localDescription }));
        select.style.display = 'none';
      } catch (err) {
        console.error("[DEBUG] fallback only video", err);
        try {
          constraints = { video: { deviceId: { exact: cameraId }, width: { ideal: 1920 }, height: { ideal: 1080 } } };
          localStream = await navigator.mediaDevices.getUserMedia(constraints);
          document.getElementById('remoteVideo').srcObject = localStream;
          localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          ws.send(JSON.stringify({ sdp: pc.localDescription }));
          select.style.display = 'none';
        } catch (e) {
          console.error("[DEBUG] Fehler beim Starten:", e);
          alert("HINT: did you start receiver first?");
          alert("HINT: app missing access to camera / microphone?");
        }
      }
    }

function stopAll() {
  console.log("[DEBUG] Stoppe alles");

      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      if (pc) {
        pc.close();
        pc = null;
      }
      localOfferSent = false;
      const senderBtn = document.getElementById('senderBtn');
      const receiverBtn = document.getElementById('receiverBtn');
      const stopBtn = document.getElementById('stopBtn');
      senderBtn.disabled = false;
      receiverBtn.disabled = false;
      senderBtn.classList.remove('active');
      receiverBtn.classList.remove('active');
      senderBtn.textContent = "send";
      receiverBtn.textContent = "receive";
      document.getElementById('cameraSelect').style.display = 'none';
      stopBtn.style.display = 'none';
      document.getElementById('localVideo').srcObject = null;
      document.getElementById('remoteVideo').srcObject = null;
    }
  </script>
</body>
</html>
