<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>robocam</title>
<style>
  body {
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    padding: 20px;
    background: linear-gradient(to bottom, #f4f4f4, #e0e0e0);
    min-height: 100vh;
  }
  #loginForm, #changeForm { margin-bottom: 20px; }
  #app { display: none; }
  #statusDisplay {
    margin-top: 10px;
    font-weight: bold;
  }
  .top-bar {
    display: flex;
    align-items: left;
    justify-content: left;
    gap: 10px;
    flex-wrap: wrap;
    width: 100%;
    max-width: 600px;
    margin-bottom: 10px;
  }
  .buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .app-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  }
  h1 {
    margin: 10px;
    font-size: 1.8em;
    color: #333;
  }
  button, select {
    font-size: 1.0em;
    padding: 8px 16px;
    margin: 0;
    width: auto;
    max-width: none;
    border: none;
    border-radius: 10px;
    background-color: #808080;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.1s;
  }
  button:hover:enabled { background-color: #45a049; }
  button:disabled { cursor: not-allowed; opacity: 0.8; }
  button.active { background-color: #00FF00; transform: scale(1.05); }
  #stopBtn { background-color: #FF0000; }
  #stopBtn:hover:enabled { background-color: #d32f2f; }
  video {
    margin-top: 1px;
    border: 2px solid #333;
    border-radius: 5px;
    background: #000000;
    object-fit: cover;
  }
  #remoteVideo { width: 80%; max-width: 100%; }
  #localVideo { width: 80%; max-width: 100%; }
  #blackoutBtn { background-color: grey; opacity: 1; z-index: 99999; }
  #audioBtn { background-color: grey; opacity: 1; z-index: 99999; }
  #blackoutArea {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background-color: black;
    opacity: 1;
    z-index: 9999;
  }
  .inline-container img { vertical-align: middle; height: 40px; }
  .inline-container span { vertical-align: middle; margin-left: 10px; font-size: 40px; }

.fullscreen-video {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 10000;
  background: black;
  object-fit: cover;     /* fill width + height, keep ratio */
  object-position: center; /* crop evenly from center */
}

.video-container {
  position: relative;
  display: inline-block;
}

.video-container video {
  display: block;
}

/* Button im normalen Modus */
#toggleFullscreenBtn {
  position: relative; /* normal im Button-Menü */
  background-color: #222;
  padding: 8px 14px;
  border-radius: 6px;
  font-size: 0.9em;
  color: white;
  z-index: 10002;
}

/* Button im Fullscreen-Video */
.fullscreen-video-container {
  position: relative;
}

.fullscreen-video-container #toggleFullscreenBtn {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 10002;
  background-color: rgba(0,0,0,0.6);
}

.fullscreen-toggle {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 10002;
}

  </style>
</head>
<body>

<!-- Login -->
<div id="loginForm">
   <h2>Login</h2>
  <input type="password" id="password" placeholder="Enter Password">
  <button onclick="login()">Login</button>
  <p id="loginMsg"></p>
</div>

<div id="changeForm" style="display:none;">
  <h3>Passwort ändern (nur Masterpasswort)</h3>
  <input type="password" id="newPassword" placeholder="New Password">
  <button onclick="changePassword()">Ändern</button>
  <p id="changeMsg"></p>
</div>

<!-- robocam App -->
<div id="app">
  <div class="inline-container">
    <img src="favicon.ico" alt="App Icon" class="app-icon">
    <span>robocam</span>v18
  </div>
  <br>
  <div class="top-bar">
    <div class="buttons">
      <button id="senderBtn" onclick="start('sender')">send</button>
      <button id="receiverBtn" onclick="start('receiver')">receive</button>
      <button id="stopBtn" onclick="stopAll()" style="display:none;">Stop</button>
      <button id="audioBtn" onclick="toggleAudio()">Audio On</button>
      <button id="blackoutBtn" onclick="blackoutScreen()">Blackout</button>
      <button id="reconnectBtn" onclick="attemptReconnect()" style="display:none;">Erneut verbinden</button>
      <button id="hideLocal" onclick="hideLocal()">Local Off</button>
      <button id="hideRemote" onclick="hideRemote()">Remote Off</button>
      <select id="cameraSelect" style="display:none;"></select>
      <button id="toggleFullscreenBtn" class="fullscreen-video-container" onclick="toggleFullscreen()" style="display:none;">Fullscreen</button>
	</div>
    <div id="blackoutArea"></div>
  </div>
  <div id="statusDisplay">Status: idle</div>
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay playsinline></video>
</div>

<script>
// --- Login / Passwort-Logik ---
async function login() {
  const pw = document.getElementById("password").value;
  const res = await fetch("/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ password: pw })
  });
  const data = await res.json();

  if (data.success) {
    document.getElementById("loginForm").style.display = "none";
	if (data.message === "master") {
       document.getElementById("changeForm").style.display = "block";
	} else {
       document.getElementById("app").style.display = "block";
	}
  } else {
    document.getElementById("loginMsg").innerText = "Wrong Password!";
  }
}

async function changePassword() {
  const newPw = document.getElementById("newPassword").value;
  const master = document.getElementById("password").value;

  const res = await fetch("/change-password", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ master: master, newPassword: newPw })
  });
  const data = await res.json();
  document.getElementById("changeMsg").innerText = data.message;
  document.getElementById("loginForm").style.display = "block";
  document.getElementById("changeForm").style.display = "none";
  document.getElementById('password').value = "";
}

// --- robocam Code ---
console.log("[DEBUG] Initialisiere robocam App");

const ConnectionState = {
  IDLE: 'idle',
  WAITING: 'waiting',
  READY: 'ready',
  CONNECTING: 'connecting',
  CONNECTED: 'connected',
  ERROR: 'error',
};

let appState = ConnectionState.IDLE;
let pc;
let localStream;
let localOfferSent = false;
let blackOut = false;
let remoteOut = true;
let localOut = true;
let myRole = null;
let audioSetting = true;
let ws;
const reconnectInterval = 3000;
const ROOM_ID = 'id1';

// WebSocket verbinden
function connectWebSocket() {
  const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${wsProtocol}://${location.host}/ws`);

  ws.onopen = () => {
    console.log("[DEBUG] WebSocket verbunden");
    if (myRole) ws.send(JSON.stringify({ type: 'register', role: myRole, roomId: ROOM_ID }));
    setAppState(ConnectionState.WAITING);
  };
  ws.onmessage = handleMessage;
  ws.onerror = e => console.error("[DEBUG] WebSocket Fehler:", e);
  ws.onclose = () => {
    console.warn("[DEBUG] WebSocket closed – try reconnect ...");
    setAppState(ConnectionState.ERROR);
    setTimeout(connectWebSocket, reconnectInterval);
  };
}
connectWebSocket();

function hideRemote() {
  remoteOut = !remoteOut;
  document.getElementById('remoteVideo').style.display = remoteOut ? 'block' : 'none';
  document.getElementById('hideRemote').textContent = remoteOut ? 'Remote On' : 'Remote Off';
}
function hideLocal() {
  localOut = !localOut;
  document.getElementById('localVideo').style.display = localOut ? 'block' : 'none';
  document.getElementById('hideLocal').textContent = localOut ? 'Local Off' : 'Local On';
}
function blackoutScreen() {
  blackOut = !blackOut;
  document.getElementById('blackoutArea').style.display = blackOut ? 'block' : 'none';
  document.getElementById('blackoutBtn').textContent = blackOut ? 'Display' : 'Blackout';
}

async function handleMessage(msg) {
  const text = msg.data instanceof Blob ? await msg.data.text() : msg.data;
  let data;
  try { data = JSON.parse(text); } catch { return; }

  if (data.type === 'receiver-ready' && myRole === 'sender') {
    setAppState(ConnectionState.READY);
    await startLocalStreamAndOffer();
    return;
  }
  if (data.sdp) {
    if (!pc) return;
    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
    if (data.sdp.type === 'offer') {
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({ sdp: pc.localDescription }));
    }
  } else if (data.candidate) {
    if (!pc) return;
    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
  }
}

async function start(role) {
  document.getElementById("loginForm").style.display = "none";
  document.getElementById("changeForm").style.display = "none";

  console.log(`[DEBUG] Starte als ${role}`);
  myRole = role;
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'register', role: myRole, roomId: ROOM_ID }));
  }
  const senderBtn = document.getElementById('senderBtn');
  const receiverBtn = document.getElementById('receiverBtn');
  const stopBtn = document.getElementById('stopBtn');
  document.getElementById('localVideo').srcObject = null;
  document.getElementById('remoteVideo').srcObject = null;
  senderBtn.disabled = true;
  receiverBtn.disabled = true;
  senderBtn.classList.remove('active');
  receiverBtn.classList.remove('active');
  senderBtn.textContent = "send";
  receiverBtn.textContent = "receive";
  if (role === 'sender') senderBtn.classList.add('active');
  if (role === 'receiver') receiverBtn.classList.add('active');
  stopBtn.style.display = 'block';
  setAppState(ConnectionState.WAITING);
  // Neue RTCPeerConnection mit STUN
  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });
  pc.ontrack = e => {
    document.getElementById('remoteVideo').srcObject = e.streams[0];
    setAppState(ConnectionState.CONNECTED);
  };
  pc.onicecandidate = e => { if (e.candidate) ws.send(JSON.stringify({ candidate: e.candidate })); };
  pc.oniceconnectionstatechange = () => {
    console.log("[DEBUG] ICE state:", pc.iceConnectionState);
    if (['disconnected','failed'].includes(pc.iceConnectionState)) {
      setAppState(ConnectionState.ERROR); attemptReconnectWithDelay(5);
    }
    if (['connected'].includes(pc.iceConnectionState)) {
      setAppState(ConnectionState.CONNECTED); attemptReconnectWithDelay(6);
    }
  };
  if (role === 'sender') {
    const select = document.getElementById('cameraSelect');
    select.style.display = 'block';
    await fillCameraSelect();
    if (select.options.length === 1) {
      await startLocalStreamAndOffer();
    } else {
      select.onchange = async () => { await startLocalStreamAndOffer(); };
    }
  }
  if (role === 'receiver') {
    document.getElementById('remoteVideo').style.display = 'block';
    document.getElementById('blackoutArea').style.display = 'none';
  }
}

async function fillCameraSelect() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoDevices = devices.filter(device => device.kind === 'videoinput');
  const select = document.getElementById('cameraSelect');
  select.innerHTML = '';
  videoDevices.forEach((device, idx) => {
    const option = document.createElement('option');
    option.value = device.deviceId;
    option.text = device.label || `Kamera ${idx + 1}`;
    select.appendChild(option);
  });
  select.onchange = async () => { await startLocalStreamAndOffer(); };
}

async function startLocalStreamAndOffer() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: audioSetting });
    document.getElementById('localVideo').srcObject = localStream;

    // Neue RTCPeerConnection mit STUN
    pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.onicecandidate = event => {
      if (event.candidate) {
        ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
      }
    };

    pc.ontrack = event => {
      document.getElementById('remoteVideo').srcObject = event.streams[0];
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({ type: 'offer', sdp: offer }));
    localOfferSent = true;
  } catch (err) {
    alert("Kamera- oder Mikrofonzugriff verweigert oder nicht verfügbar.");
  }
}


function toggleAudio() {
  audioSetting = !audioSetting;
  if (localStream) { localStream.getAudioTracks().forEach(t => t.enabled = audioSetting); }
  document.getElementById('audioBtn').textContent = audioSetting ? 'Audio On' : 'Audio Off';
}

function stopAll() {
  setAppState(ConnectionState.IDLE);
  localOfferSent = false;
  if (pc) { pc.close(); pc = null; }
  if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
  document.getElementById('senderBtn').disabled = false;
  document.getElementById('receiverBtn').disabled = false;
  document.getElementById('senderBtn').classList.remove('active');
  document.getElementById('receiverBtn').classList.remove('active');
  document.getElementById('stopBtn').style.display = 'none';
  document.getElementById('cameraSelect').style.display = 'none';
  document.getElementById('localVideo').srcObject = null;
  document.getElementById('remoteVideo').srcObject = null;
  document.getElementById('blackoutArea').style.display = 'none';
}

function attemptReconnectWithDelay(seconds) {
  setTimeout(() => {
    if (!pc || pc.iceConnectionState === 'disconnected') {
      console.log("[DEBUG] Versuche erneut zu verbinden with delay");
      stopAll(); if (myRole) start(myRole);
    }
  }, seconds * 1000);
}
function attemptReconnect() {
  console.log("[DEBUG] Versuche erneut zu verbinden");
  if (appState === ConnectionState.ERROR) { stopAll(); if (myRole) start(myRole); }
}

let fullscreenMode = false;

function toggleFullscreen() {
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const toggleBtn = document.getElementById('toggleFullscreenBtn');
  const otherButtons = document.querySelectorAll('.buttons button:not(#toggleFullscreenBtn)');
  const statusDisplay = document.getElementById('statusDisplay');

  if (!fullscreenMode) {
    if (myRole === 'sender') {
      localVideo.classList.add('fullscreen-video');
      remoteVideo.style.display = 'none';
    } else if (myRole === 'receiver') {
      remoteVideo.classList.add('fullscreen-video');
      localVideo.style.display = 'none';
    }

    otherButtons.forEach(btn => btn.style.display = 'none');
    statusDisplay.style.display = 'none';
    toggleBtn.textContent = "Zurück";
    toggleBtn.style.display = 'block';
    fullscreenMode = true;
  } else {
    localVideo.classList.remove('fullscreen-video');
    remoteVideo.classList.remove('fullscreen-video');
    remoteVideo.style.display = 'block';
    localVideo.style.display = 'block';

    otherButtons.forEach(btn => btn.style.display = '');
    statusDisplay.style.display = '';
    toggleBtn.textContent = "Fullscreen";
    fullscreenMode = false;
  }
}

// *** FIXED: einheitliche, vollständige Version ***
function setAppState(state) {
  appState = state;
  console.log(`[STATE] ${state}`);
  const statusEl = document.getElementById('statusDisplay');
  const reconnectEl = document.getElementById('reconnectBtn');
  const toggleFsEl = document.getElementById('toggleFullscreenBtn');

  if (statusEl) statusEl.textContent = `Status: ${state}`;
  if (reconnectEl) reconnectEl.style.display = (state === ConnectionState.ERROR) ? 'block' : 'none';
  if (toggleFsEl) toggleFsEl.style.display = (state === ConnectionState.CONNECTED) ? 'block' : 'none';
}
</script>
</body>
</html>
